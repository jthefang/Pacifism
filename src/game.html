<!-- TODO
	Have the game level up, pt multipliers

	Add techno music sound FX

	Slightly accelerate the player/drones when beginning to move, changing directions, coming to a stop
-->

<!doctype html>
<title>Pacifism</title>
<link rel="stylesheet" href="gameStyle.css">
<head>
  <script src="jquery.js"></script>
  <script src="functional.js"></script>
  <script src="sprites.js"></script>
</head>

<audio id="theme">
	<source src="../sounds/theme.mp3" type="audio/mpeg" loop>
</audio>
<audio id="game_start">
	<source src="../sounds/game_start.mp3" type="audio/mpeg">
</audio>
<audio id="game_over">
	<source src="../sounds/game_over.mp3" type="audio/mpeg">
</audio>
<audio id="drone_spawn">
	<source src="../sounds/drone_spawn.mp3" type="audio/mpeg">
</audio>
<audio id="gate_explode">
	<source src="../sounds/gate_explode.mp3" type="audio/mpeg">
</audio>

<div id="container">
	<canvas>Your browser doesn't support canvas. Please upgrade it. We recommend <a href = ”https://www.google.com/chrome/index.html”>Google Chrome</a>.</canvas>

	<div id="menu">
		<form>
		  <input type="radio" name="inputMethod" id="mouse" value="mouse" checked><label for="mouse"> Mouse</label><br>
		  <input type="radio" name="inputMethod" id="kbd" value="kbd"><label for="kbd"> Keyboard</label><br>
		  <input type="checkbox" name="endable" id="endable" value="endable"><label for="endable"> God mode</label><br>
		</form>
		<br>

		<table>
			<tr>
				<td>ESC</td>
				<td>Open menu (Pause/Play)</td>
			</tr>

			<tr>
				<td>R</td>
				<td>Restart</td>
			</tr>
		</table>
	</div>	

	<p id="help_hint">Press ESC for Menu</p>
	<p id="score"></p>
</div>

<script>
	
	/******************************		INSTANCE VARIABLES 		*******************/
	var WINDOW_HEIGHT = $(window).innerHeight();
	var WINDOW_WIDTH = $(window).innerWidth();

	/******************************		CANVAS SETUP 		***********************/
	var canvas = document.querySelector("canvas");
	canvas.width = WINDOW_WIDTH;
    canvas.height = WINDOW_HEIGHT;
	var drawingSurface = canvas.getContext("2d");
	
	var IMG_SRC = "../images/";

	/******************************		GAME STUFF 		*******************/
	var endable = true; //will determine whether the game ends if player collides with drones
	var ended = false;
	var gameScore = 0;
	var gameSpeed = 1; //should ramp up logarithmically with the score

	var controlMethod = {
		MOUSE: 0,
		KBD: 1
	}
	var currentControlMethod = controlMethod.MOUSE;

	var GAME_STATE = {
		LOADING: 0,
		STARTING: 1,
		PLAYING: 2,
		PAUSED: 3,
		ENDED: 4
	};
	var currentGameState = GAME_STATE.LOADING;
	var animationLoop;

	// ********** SUBMARK: - assets
	var assetsToLoad = [];
	var assetsLoaded = 0;

	// ********************************** IMAGES
	var gateImage = new Image();
	gateImage.addEventListener("load", loadHandler, false);
	gateImage.src = IMG_SRC + gate.imgSrc;
	assetsToLoad.push(gateImage);

	var burstImage = new Image();
	burstImage.addEventListener("load", loadHandler, false);
	burstImage.src = IMG_SRC + explosion.imgSrc;
	assetsToLoad.push(burstImage);

	// ********************************** SOUNDS
	var themeMP3 = document.querySelector("#theme"); //get reference to the sound
	themeMP3.addEventListener("canplaythrough", loadHandler, false); //means that the sound has been completely loaded
	themeMP3.load(); //load into JS
	assetsToLoad.push(themeMP3);

	var game_startMP3 = document.querySelector("#game_start"); //get reference to the sound
	game_startMP3.addEventListener("canplaythrough", loadHandler, false); //means that the sound has been completely loaded
	game_startMP3.load(); //load into JS
	assetsToLoad.push(game_startMP3);

	var game_overMP3 = document.querySelector("#game_over"); //get reference to the sound
	game_overMP3.addEventListener("canplaythrough", loadHandler, false); //means that the sound has been completely loaded
	game_overMP3.load(); //load into JS
	assetsToLoad.push(game_overMP3);

	var drone_spawnMP3 = document.querySelector("#drone_spawn"); //get reference to the sound
	drone_spawnMP3.addEventListener("canplaythrough", loadHandler, false); //means that the sound has been completely loaded
	drone_spawnMP3.load(); //load into JS
	assetsToLoad.push(drone_spawnMP3);

	var gate_explodeMP3 = document.querySelector("#gate_explode"); //get reference to the sound
	gate_explodeMP3.addEventListener("canplaythrough", loadHandler, false); //means that the sound has been completely loaded
	gate_explodeMP3.load(); //load into JS
	assetsToLoad.push(gate_explodeMP3);

	// ********** SUBMARK: - sprites
	var drones = [];
	var gates = [];
	var explosions = [];

	function loadHandler() { 
		//add listeners below...
		window.addEventListener("mousemove", mousemoveHandler, false);

		assetsLoaded++;
		if(assetsLoaded == assetsToLoad.length) {
			//Remove the load event listeners
			gateImage.removeEventListener("load", loadHandler, false);
			burstImage.removeEventListener("load", loadHandler, false);

			themeMP3.removeEventListener("canplaythrough", loadHandler, false);
			game_startMP3.removeEventListener("canplaythrough", loadHandler, false);
			game_overMP3.removeEventListener("canplaythrough", loadHandler, false);
			drone_spawnMP3.removeEventListener("canplaythrough", loadHandler, false);
			gate_explodeMP3.removeEventListener("canplaythrough", loadHandler, false);

			//Start the game
			currentGameState = GAME_STATE.STARTING;
		}
	}

	function startGame() {
		//initalize characters
		player.spawn();
		spawnDrones();
		spawnGate();

		game_startMP3.volume = 1;
		game_startMP3.play();
		//Loop play the themeMP3
		themeMP3.addEventListener('ended', function() {
		    this.currentTime = 0;
		    this.play();
		}, false);
		themeMP3.volume = 1.0; //start volume at max
		themeMP3.currentTime = 0; //start at beginning
		themeMP3.play();

		currentGameState = GAME_STATE.PLAYING;
	}

	function playGame() {
		console.log(currentGameState);

		//update players position
	  	player.updatePosition();

	  	//update drone positions
	  	for (var j = 0; j < drones.length; j++) {
			drones[j].updatePosition();	

			//also pairwise block overlap of the drones' positions (so they don't collide with each other)
			for (var k = j + 1; k < drones.length; k++) {
				blockCircleOverlap(drones[j], drones[k]);
			}
		}

		//check for player collision with a drone
		for (var k = 0; k < drones.length; k++) {
			if (collisionCircle(player, drones[k]) && !drones[k].dead && endable) {
				currentGameState = GAME_STATE.ENDED;
			}
		}

		//update gate positions
	  	for (var i = 0; i < gates.length; i++) {
			gates[i].updatePosition();	
		}

		//update explosions
		for (var m = 0; m < explosions.length; m++) {
			explosions[m].updateAnimation();	
		}

		droneNextSpawnTime -= Math.ceil(1000 / 60); //60fps
		gateNextSpawnTime -= Math.ceil(1000 / 60);
		if (droneNextSpawnTime <= 0) {
			spawnDrones(); //resets droneNextSpawnTime
		}
		if (gateNextSpawnTime <= 0) {
			spawnGate();
		}

		updateGameLevel();
	}

	function togglePause() {
		if (currentGameState == GAME_STATE.PLAYING) {
			currentGameState = GAME_STATE.PAUSED;
			themeMP3.pause();
		} else if (currentGameState == GAME_STATE.PAUSED) {
			currentGameState = GAME_STATE.PLAYING;
			themeMP3.play();
		}
	}

	function endGame() {
		ended = true;

		//display some Game Over message and let the user restart the game
		themeMP3.pause();
		game_overMP3.currentTime = 0;
		game_overMP3.volume = 1.0;
		game_overMP3.play();
	}

	function restartGame() {
		drones = [];
		gates = [];
		explosions = [];

		droneSpawnAmount = INITIAL_DRONE_SPAWN_AMOUNT;
		maxGateSpawnAmount = INITIAL_GATE_SPAWN_AMOUNT;

		ended = false;
		gameScore = 0;
		gameSpeed = 1;

		game_overMP3.pause(); //if it's playing

		startGame();	
	}

	function applyMenuSettings() {
		var inputMethod = $('input[name="inputMethod"]:checked').val();
		if (inputMethod === "mouse") {
			currentControlMethod = controlMethod.MOUSE;
			canvas.addEventListener("mousemove", mousemoveHandler, false);
		} else if (inputMethod === "kbd") {
			currentControlMethod = controlMethod.KBD;
			canvas.removeEventListener("mousemove", mousemoveHandler, false);
		}

		endable = !$("input#endable").is(":checked");
	}

	function updateGameLevel() {
		//ramp up gamespeed
		if (gameScore > 10000) {
			gameSpeed = 2.0;
			droneSpawnAmount = 40;
		} else if (gameScore > 5000) {
			gameSpeed = 1.7;
			maxGateSpawnAmount = 3;
			droneSpawnAmount = 30;
		} else if (gameScore > 3000) {
			gameSpeed = 1.5;
		} else if (gameScore > 1000) { 
			gameSpeed = 1.2;
			maxGateSpawnAmount = 2;
		} 
	}

	/******************************		EVENT HANDLERS 		*******************/
	// ********* SUBMARK: - keyboard stuff
	var kbd = {
		r: 82,
		p: 80,
		esc: 27,
		left: 37,
		up: 38,
		right: 39,
		down: 40
	}

	$(document).keydown(function(e) {
		var key = e.which;

	    switch(key) { 
			case kbd.left:
				player.moveLeft = true;
				break;
			case kbd.up:
				player.moveUp = true;
				break;
			case kbd.right:
				player.moveRight = true;
				break;
			case kbd.down:
				player.moveDown = true;
				break;
	    	case kbd.r:
	    		if (!$("div#menu").is(':visible')) { //only if menu is not open
	    			restartGame();	
	    		}
	    		break;
	    	case kbd.esc:
	    		togglePause();

	    		$("div#menu").toggle();
	    		
	    		if (currentGameState == GAME_STATE.PLAYING) {
	    			//apply new settings
	    			applyMenuSettings();
	    		}
	    		break;
	  	}
	});

	$(document).keyup(function(e) {
		var key = e.which;

	    switch(key) { 
			case kbd.left:
				player.moveLeft = false;
				break;
			case kbd.up:
				player.moveUp = false;
				break;
			case kbd.right:
				player.moveRight = false;
				break;
			case kbd.down:
				player.moveDown = false;
				break;
	  	}
	});

	// ********* SUBMARK: - Have the player follow the mouse movement
	var mouseX;
	var mouseY;
	function mousemoveHandler(event) {
		mouseX = event.pageX - canvas.offsetLeft;
		mouseY = event.pageY - canvas.offsetTop;
		//console.log("x: " + mouseX + " y: " + mouseY);
		
		if ((Math.abs(mouseX - player.xPos) >= player.radius) || Math.abs(mouseY - player.yPos) >= player.radius) {
			//only move the player if mouse is not over the player (this prevents jittery movement)
			player.moveToPos(mouseX, mouseY);	
		}
	}

	/**********************		DOC READY, ANIMATION & RENDERING 	************/
	function updateAnimation() { 
	  	// Call updateAnimation at a smooth rate (depends on computer display's refresh rate)
	  	// you could optionally use a timer
	  	animationLoop = window.requestAnimationFrame(updateAnimation, canvas); 
	  	
	  	switch (currentGameState) {
	  		case GAME_STATE.LOADING:
	  			break;
	  		case GAME_STATE.STARTING:
	  			startGame();
	  			break;
	  		case GAME_STATE.PLAYING:
	  			playGame();
	  			break;
	  		case GAME_STATE.PAUSED:
	  			//do nothing
	  			break;
	  		case GAME_STATE.ENDED:
	  			if (endable) {
		  			if (!ended) { //only call endGame once
			  			endGame();
		  			}
	  			} else {
	  				playGame();
	  			}

	  			break;
	  	}
	  	
	  	//Render the animation
	  	render();
	}

	function render() {
		//console.log("xVel: " + player.xVel + " yVel: " + player.yVel);
		//console.log("xPos: " + player.xPos + " yPos: " + player.yPos);

		//Clear the current canvas
		drawingSurface.clearRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
		
		//fill black background
		drawingSurface.rect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
		drawingSurface.fillStyle = "black";
		drawingSurface.fill();

		player.draw();

		//draw all the drones
		for (var k = 0; k < drones.length; k++) {
			drones[k].draw();	
		}

		//draw all the gates
		for (var m = 0; m < gates.length; m++) {
			gates[m].draw();	
		}

		//draw all the explosions
		for (var n = 0; n < explosions.length; n++) {
			explosions[n].draw();	
		}

		//show score
		$("p#score").text(gameScore.toString());
	}

	$(document).ready(function() {
		//center the menu
		var menuHeight = $("div#menu").outerHeight(); 
		var menuWidth = $("div#menu").outerWidth();
		$("div#menu").css("left", (canvas.width / 2) - (menuWidth / 2))
			.css("top", (canvas.height / 2) - (menuHeight / 2));

	  	//Start the animation loop
	  	updateAnimation();
	});

</script>