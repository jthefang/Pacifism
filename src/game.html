<!-- TODO 
	Slightly accelerate the player/drones when beginning to move, changing directions, coming to a stop

	Add gates
-->

<!doctype html>
<title>Pacifism</title>
<link rel="stylesheet" href="gameStyle.css">
<head>
  <script src="jquery.js"></script>
  <script src="functional.js"></script>
  <script src="sprites.js"></script>
</head>

<canvas>Your browser doesn't support canvas. Please upgrade it. We recommend <a href = ”https://www.google.com/chrome/index.html”>Google Chrome</a>.</canvas>

<script>
	
	// ***************** Basic instance variables
	var WINDOW_HEIGHT = $(window).innerHeight();
	var WINDOW_WIDTH = $(window).innerWidth();

	//Set up the canvas and drawing surface
	var canvas = document.querySelector("canvas");
	canvas.width = WINDOW_WIDTH;
    canvas.height = WINDOW_HEIGHT;
	var drawingSurface = canvas.getContext("2d");
	
	// ***************** MARK: - game stuff
	var IMG_SRC = "../images/";
	var endable = false; //will determine whether the game ends if player collides with drones
	var GAME_STATE = {
		LOADING: 0,
		STARTING: 1,
		PLAYING: 2,
		ENDED: 3
	};
	var currentGameState = GAME_STATE.LOADING;
	var animationLoop;

	// ********** SUBMARK: - assets
	var assetsToLoad = [];
	var assetsLoaded = 0;
	var gateImage = new Image();
	gateImage.addEventListener("load", loadHandler, false);
	gateImage.src = IMG_SRC + gate.imgSrc;
	assetsToLoad.push(gateImage);

	// ********** SUBMARK: - sprites
	var drones = [];
	var gates = [];

	function startGame() {
		//initalize characters
		player.spawn();
		spawnDrones();
		spawnGate();

		currentGameState = GAME_STATE.PLAYING;
	}

	function playGame() {
		//update players position
	  	player.updatePosition();

	  	//update drone positions
	  	for (var j = 0; j < drones.length; j++) {
			drones[j].updatePosition();	

			//also pairwise block overlap of the drones' positions (so they don't collide with each other)
			for (var k = j + 1; k < drones.length; k++) {
				blockCircleOverlap(drones[j], drones[k]);
			}
		}

		//check for player collision with a drone
		for (var k = 0; k < drones.length; k++) {
			if (collisionCircle(player, drones[k]) && endable) {
				currentGameState = GAME_STATE.ENDED;
			}
		}

		//update gate positions
	  	for (var i = 0; i < gates.length; i++) {
			gates[i].updatePosition();	
		}
	}

	function endGame() {
		//display some Game Over message and let the user restart the game
		window.cancelAnimationFrame(animationLoop);
	}

	// ***************** MARK: - Event handlers
	// ********* SUBMARK: - keyboard stuff
	var kbd = {
		q: 113,
		w: 119,
		e: 101,
		r: 114,
		left: 37,
		up: 38,
		right: 39,
		down: 40
	}

	$(document).keydown(function(e) {
		var key = e.which;
	    //console.log(key);

	    switch(key) { 
			case kbd.left:
				player.moveLeft = true;
				break;
			case kbd.up:
				player.moveUp = true;
				break;
			case kbd.right:
				player.moveRight = true;
				break;
			case kbd.down:
				player.moveDown = true;
				break;
	  	}
	});

	$(document).keyup(function(e) {
		var key = e.which;
	    //console.log(key);

	    switch(key) { 
			case kbd.left:
				player.moveLeft = false;
				break;
			case kbd.up:
				player.moveUp = false;
				break;
			case kbd.right:
				player.moveRight = false;
				break;
			case kbd.down:
				player.moveDown = false;
				break;
	  	}
	});

	// ********* SUBMARK: - Have the player follow the mouse movement
	var IS_MOUSE_MOVING = false;
	var mouseMoveTimer = setTimeout(mouseStopped,300);
	function mousemoveHandler(event) {
		clearTimeout(mouseMoveTimer); //to see when the mouse stops moving
		mouseMoveTimer = setTimeout(mouseStopped, 300);

		IS_MOUSE_MOVING = true;

		var mouseX = event.pageX - canvas.offsetLeft;
		var mouseY = event.pageY - canvas.offsetTop;
		//console.log("x: " + mouseX + " y: " + mouseY);
		
		player.moveToPos(mouseX, mouseY);
	}

	function mouseStopped() {
		IS_MOUSE_MOVING = false;
	}

	// ***************** MARK: - after page has loaded, animation and rendering
	function loadHandler() { 
		//add listeners below...
		canvas.addEventListener("mousemove", mousemoveHandler, false);

		assetsLoaded++;
		if(assetsLoaded == assetsToLoad.length) {
			//Remove the load event listener
			gateImage.removeEventListener("load", loadHandler, false);
			 
			//Start the game
			currentGameState = GAME_STATE.STARTING;
		}
		console.log(currentGameState);
	}

	function updateAnimation() { 
	  	// Call updateAnimation at a smooth rate (depends on computer display's refresh rate)
	  	// you could optionally use a timer
	  	animationLoop = window.requestAnimationFrame(updateAnimation, canvas); 
	  	
	  	switch (currentGameState) {
	  		case GAME_STATE.LOADING:
	  			break;
	  		case GAME_STATE.STARTING:
	  			startGame();
	  			break;
	  		case GAME_STATE.PLAYING:
	  			playGame();
	  			break;
	  		case GAME_STATE.ENDED:
	  			endGame();
	  			break;
	  	}
	  	
	  	//Render the animation
	  	render();
	}

	function render() {
		//console.log("xVel: " + player.xVel + " yVel: " + player.yVel);
		//console.log("xPos: " + player.xPos + " yPos: " + player.yPos);

		//Clear the current canvas
		drawingSurface.clearRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
		
		//fill black background
		drawingSurface.rect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
		drawingSurface.fillStyle = "black";
		drawingSurface.fill();

		player.draw();

		//draw all the drones
		for (var k = 0; k < drones.length; k++) {
			drones[k].draw();	
		}

		//draw all the gates
		for (var m = 0; m < gates.length; m++) {
			gates[m].draw();	
		}
	}

	$(document).ready(function() {
	  	//Start the animation loop
	  	updateAnimation();
	});

</script>